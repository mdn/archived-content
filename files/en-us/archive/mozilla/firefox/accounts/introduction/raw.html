<p><strong>Firefox Accounts (FxA)</strong> is an identity provider that provides authentication and user profile data for Mozilla cloud services.  We are also exploring the possibility of allowing non-Mozilla services to delegate authentication to Firefox Accounts.</p>

<p>Creating a Firefox Account requires a user to give us a pre-existing email address and choose a password. The user must verify their email address via an email link sent to the email address she provided. The user will not be able to login to attached services prior to verifying her email address. </p>

<p>To login to an existing Firefox Account, the user must provide the email address and password given during account creation. If the user forgets her password, she can reset via an email link sent to the email address given during account creation. </p>

<p>All new relying services should integrate with Firefox Accounts via the <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md">OAuth 2.0 API</a>.  There is also a legacy API based on the BrowserID protocol, which is available only in some Firefox user agents and is not recommended for new applications.</p>

<h2 id="OAuth_2.0_API"><span style="line-height: 1.5;">OAuth 2.0 API</span></h2>

<p><span style="line-height: 1.5;">The OAuth 2.0 API is the </span><strong style="line-height: 1.5;">preferred method</strong><span style="line-height: 1.5;"> of integrating with Firefox Accounts.  It is built on open standards, is available across all platforms, and gives relying services access to user profile data.  To delegate authentication to Firefox Accounts in this manner, you will first need to register for OAuth relier credentials, then add support for a HTTP redirection-based login flow to your service.</span></p>

<h3 id="Becoming_a_Firefox_Accounts_relier">Becoming a Firefox Accounts relier</h3>

<div class="note">
<p>Firefox Accounts integration is currently recommended only for Mozilla-hosted services. We are exploring the possibility of allowing non-Mozilla services to delegated authentication to Firefox Accounts, and would welcome discussion of potential use-cases on the <a href="https://mail.mozilla.org/pipermail/dev-fxacct/">mailing list</a>.</p>
</div>

<p>All reliers need to register the following information with Firefox Accounts:</p>

<ul>
 <li><strong>name</strong> - a user friendly name for your service, e.g., "Firefox Marketplace".</li>
 <li><strong>redirect_uri</strong> - a HTTPS endpoint on your service, to which we can return the user after authentication has completed.</li>
</ul>

<p>In return, your service will be allocated a set of OAuth client credentials:</p>

<ul>
 <li><strong>client_id</strong> - an 8 byte hex encoded client identifier for your service. This value is not secret.</li>
 <li><strong>client_secret</strong> - a 32 byte hex encoded secret for your service to authenticate itself to the back end FxA OAuth service. <strong>This value is secret.</strong> Despite its name, this value should <strong>never</strong> be stored on or given to untrusted client code on users' machines. It should only be used from the service's backend machines to access authenticated API endpoints on the Firefox Accounts OAuth server (e.g., <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md#post-v1token">https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md#post-v1token</a>).</li>
</ul>

<p>For <strong>development purposes</strong> you can use the <a href="/en-US/Firefox_Accounts_OAuth_Dashboard">Firefox Accounts OAuth Credential Management dashboard</a> to provision relier credentials.  Our development environments support "127.0.0.1" and "localhost" as valid "redirectUri" values to ease local development.</p>

<p><span style="line-height: 1.5;">Registration of new <strong>production reliers</strong> is currently a manual process.  Send an email to <a href="https://mail.mozilla.org/listinfo/dev-fxacct">dev-fxacct@mozilla.org</a> to inform us of your desire to be a relying service, and include the desired <strong>name</strong> and <strong>redirect_uri</strong>.</span>  We will work with you to provision client credentials, possibly with multiple versions for different environments (e.g., production, development, etc.):</p>

<ul>
</ul>

<p>Note that the <strong>client_secret</strong> is <em>your responsibility</em> to keep safe. If you lose it, we have no way to recover it, and it will be necessary to issue you a new secret. </p>

<p>We also recommend that you subscribe to the <a href="https://mail.mozilla.org/listinfo/fxacct-notices">Firefox Accounts notices</a> mailing list, a low-traffic list that is used to publish important feature updates and security information.</p>

<h3 id="Authenticating_with_Firefox_Accounts">Authenticating with Firefox Accounts</h3>

<div>Firefox Accounts provides a <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md" style="line-height: 1.5;">OAuth 2.0 API</a> that implements a subset of <span style="line-height: 1.5;"><a href="http://openid.net/connect/">OpenID Connect</a></span>.<span style="line-height: 1.5;"> Reliers can use this to build a redirect or popup based Firefox Accounts login flow. Currently, using this API directly is the only integration choice for Web applications. Longer term we recommend using the below Javascript client libraries, but these are still a work in progress.</span></div>

<div></div>

<h4 id="Endpoint_Discovery">Endpoint Discovery</h4>

<p>Given the URL of the Firefox Accounts server, reliers should fetch the <a href="http://openid.net/specs/openid-connect-discovery-1_0.html">OpenID Connect Discovery Document</a> from <a href="https://accounts.firefox.com/.well-known/openid-configuration">/.well-known/openid-configuration</a>.  This will return a JSON document with all the endpoint URLs necessary to complete the login flow.  In particular it will contain:</p>

<ul>
 <li>"authorization_endpoint": the URL to which the client should be directed to begin the authentication flow</li>
 <li>"token_endpoint": the URL at which an OAuth access code can be exchanged for an access token</li>
 <li>"userinfo_endpoint": the URL at which additional user profile data can be obtained</li>
</ul>

<h4 id="Initiating_login">Initiating login</h4>

<div><span style="line-height: 1.5;">The recommended steps for initiating login with the HTTP API directly are:</span></div>

<div></div>

<ol>
 <li><strong>Establish a session with the client.</strong> This session is between the relying service (i.e., your server) and the client wishing to authenticate itself. The implementation details of this session are up to the relying service, e.g., it could use cookies.</li>
 <li><strong>Provide the OAuth parameters to the client.</strong> These parameters include:
  <ul>
   <li><strong>client_id</strong> - the 8 byte hex encoded client identifier for your relying service established during the provisioning of your service with the FxA team</li>
   <li><strong>redirect_uri</strong> - the <strong>redirect_uri</strong> you gave the FxA team during the provisioning of your service</li>
   <li><strong>scope</strong> - the requested scope of FxA user data or API access. Currently, only <strong>profile</strong> and related sub-scopes (e.g., <strong>profile:email</strong>) are supported.</li>
   <li><strong>state -</strong> an alphanumeric value created by the relying service and associated with client's session. It's up to the relying service how this can be used, but it's primary and recommended purpose is to prevent forgery attacks.</li>
  </ul>
 </li>
 <li><strong>Navigate the user's client to the FxA OAuth authorization endpoint.</strong>  This URL should come from the "authorization_endpoint" key in the discovery document, and the request must include URL query parameters for the service's <strong>client_id </strong>and a <strong>state</strong> value. Refer to the <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md#get-v1authorization">FxA OAuth documentation</a> for further information about this step and optional parameters.</li>
</ol>

<h4 id="Authenticating_the_user">Authenticating the user</h4>

<p>After navigating the user's client to the authorization endpoint, the user will be asked to authenticate with her Firefox account or create an account if she doesn't have one:</p>

<p style="text-align: center;"><a href="https://cloud.githubusercontent.com/assets/2365255/3786584/98e45f56-19dc-11e4-9e97-3a997e210972.png"><img alt="" src="https://cloud.githubusercontent.com/assets/2365255/3786584/98e45f56-19dc-11e4-9e97-3a997e210972.png" style="height: 387px; width: 300px;"></a></p>

<h4 id="Redirect_back_to_the_relying_service">Redirect back to the relying service</h4>

<p>After the user authenticates herself, Firefox Accounts transfers control back to the relying service. On the Web, this happens by redirecting the user's browser back to the <strong>redirect_uri</strong> endpoint provisioned for the relier. The following information will be provided in the query parameters:</p>

<ul>
 <li><strong>client_id</strong> - the 8 byte hex encoded client identifier for your relying service</li>
 <li><strong>state</strong> - the state value provided by the relying service when it navigated the user's client to the FxA OAuth authorization endpoint</li>
 <li><strong>code</strong> - an alphanumeric string that the relying service can exchange for an Firefox Accounts OAuth 2.0 access token for the user. A <strong>code</strong> typically has a lifetime of 15 minutes.</li>
</ul>

<p>The relying service should make the following security checks:</p>

<ul>
 <li>Verify the <strong>client_id</strong> in the redirect request matches its own <strong>client_id</strong>.</li>
 <li>Verify the <strong>state</strong> in the redirect request matches the <strong>state</strong> value previously associated with the client session.</li>
</ul>

<p>A failure in either of these verifications indicates a security error and the relying service should re-start the login flow. If the relying service receives one of these requests when the client session is already associated with a FxA user, it should be ignored.</p>

<h4 id="Obtaining_an_OAuth_access_token">Obtaining an OAuth access token</h4>

<p>If the above security checks pass, the relying service can proceed to exchange the <strong>code</strong> provided in the redirect from Firefox Accounts for an <strong>OAuth token</strong> for the user. This <strong>must</strong> be done from the relying service's backend server and not from untrusted client code. The service can exchange the <strong>code</strong> using the <a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md#post-v1token">"token_endpoint"</a> URL from the discovery document. Refer to the linked documentation for further details. </p>

<h4 id="Accessing_profile_data">Accessing profile data</h4>

<p>The access token can now be used to fetch the user's profile data.  Make a GET request to the "userinfo_endpoint" URL obtained from the discovery document, passing the access in the Authorization header as a <a href="http://tools.ietf.org/html/rfc6750">bearer token</a>.  The response will be a JSON document which may include the following fields:</p>

<ul>
 <li>uid:  the user's opaque, stable account identifier</li>
 <li>email:  the user's verified email address</li>
 <li>displayName:  the user's preferred human-readable display name</li>
 <li>avater: the URL of the user's profile picture</li>
</ul>

<p>Some fields may be missing if the appropriate scopes were not requested, or the user declined to share the information.</p>

<h4 id="Security_considerations">Security considerations</h4>

<p>The FxA OAuth token should <strong><em>only </em></strong>be used as an authentication token to access FxA APIs. It should not:</p>

<ul>
 <li>be sent to untrusted parties</li>
 <li>be used as a sessioning mechanism to track logged in users.</li>
</ul>

<p>Relying services should have their own sessioning mechanism independent of FxA OAuth tokens.</p>

<h3 id="Login_with_FxAccountsOAuthClient_on_Firefox_Desktop">Login with FxAccountsOAuthClient on Firefox Desktop</h3>

<p>For chrome code in Firefox Desktop, we provide <a href="/en-US/docs/Mozilla/JavaScript_code_modules/FxAccountsOAuthClient.jsm">FxAccountsOAuthClient.jsm</a> for easy integration with FxA OAuth. Relying services must first <a href="#Becoming_a_Firefox_Accounts_OAuth_relier">become an FxA OAuth relier</a>. </p>

<h3 id="Login_with_OAuth_into_Firefox_Desktop_WebExtensions">Login with OAuth into Firefox Desktop WebExtensions</h3>

<p>You can use the existing <a href="/en-US/docs/Mozilla/Add-ons/WebExtensions/API/identity/launchWebAuthFlow">identity.launchWebAuthFlow</a> APIs to integrate your WebExtensions with Firefox Accounts. The system also supports <a href="/en-US/docs/">PKCE</a> OAuth public clients to create extensions without server components. The <a href="/en-US/docs/">fxa-crypto-relier library</a> provides an abstraction for Firefox Accounts login in WebExtensions:</p>

<pre class="notranslate">const fxaKeysUtil = new fxaCryptoRelier.OAuthUtils();

fxaKeysUtil.launchWebExtensionKeyFlow('YOUR_CLIENT_ID', {
  redirectUri: browser.identity.getRedirectURL(),
  scopes: ['profile', 'https://identity.mozilla.com/apps/lockbox'],
}).then((loginDetails) =&gt; {
  const key = loginDetails.keys['https://identity.mozilla.com/apps/lockbox'];
  const credentials = {
    access_token: loginDetails.access_token,
    refresh_token: loginDetails.refresh_token,
    key
};</pre>

<p><img alt="" src="https://www.lucidchart.com/publicSegments/view/c83f8946-5bee-4fdd-bc77-22960c680356/image.jpeg" style="height: 590px; width: 780px;"></p>

<h2 id="End-to-end_encryption_feature" style="line-height: 30px;">End-to-end encryption feature</h2>

<p>Firefox Accounts offers an end-to-end encryption feature for OAuth reliers by deriving a strong encryption key from user's password. You can find more information about this feature on its <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/Firefox_Accounts/Firefox_Accounts_End-to-end_encryption">own documentation page</a>.</p>

<h2 id="Legacy_BrowserID_API" style="line-height: 30px;">Legacy BrowserID API</h2>

<div class="note">
<p>Integrating services should use the OAuth2.0 API. The BrowserID API is reserved for existing legacy applications.</p>
</div>

<p>The Firefox Accounts BrowserID is available to chrome code in Firefox Desktop and Firefox of Android.</p>

<h3 id="Firefox_Desktop">Firefox Desktop</h3>

<div class="note">
<p>The BrowserID based FxA API is currently used by Firefox Sync. Going forward, we recommend chrome based services in Firefox Desktop integrate with <a href="#Oauth_API">FxA OAuth</a> using the <a href="/en-US/docs/Mozilla/JavaScript_code_modules/FxAccountsOAuthClient.jsm">FxAccountsOAuthClient</a>.</p>
</div>

<p>Implementation of the BrowserID based FxA API on Desktop: <a href="https://github.com/mozilla/gecko-dev/blob/master/services/fxaccounts/FxAccounts.jsm">https://github.com/mozilla/gecko-dev/blob/master/services/fxaccounts/FxAccounts.jsm</a></p>

<h3 id="Firefox_for_Android">Firefox for Android</h3>

<p>WIP</p>

<h2 id="Firefox_Accounts_user_data" style="line-height: 30px;"><span style="font-size: 2.142857142857143rem;">Firefox Accounts user data</span></h2>

<p>Firefox Accounts only stores core identity data and associated profile information about users. Firefox Accounts does not store user data specific to relying services. This is responsibility of each relying service. Core identity data stored in Firefox Accounts includes:</p>

<ul>
 <li>a stable user identifier (uid)</li>
 <li>the user provided email address</li>
 <li>a cryptographically stretched password verifier</li>
 <li>the user's locale provided by her browser during account creation</li>
 <li>optional display name</li>
 <li><span style="line-height: 1.5;">optional profile image</span></li>
</ul>

<h3 id="​Using_a_OAuth_token"><span style="line-height: 1.5;">​Using a OAuth token</span></h3>

<p><span style="line-height: 1.5;">After a relying service has obtained an FxA OAuth access token for a FxA user, it can access Mozilla service APIs that use FxA OAuth. This is largely a work in progress, and we expect the number of APIs that use FxA OAuth will grow and evolve over time.</span></p>

<h4 id="Firefox_Accounts_profile_server">Firefox Accounts profile server</h4>

<p>The Firefox Accounts profile server stores and provides user "profile data". Please refer to the <a href="https://github.com/mozilla/fxa-profile-server/blob/master/docs/API.md">FxA profile server documentation</a> for further information. We provide <a href="/en-US/docs/Mozilla/JavaScript_code_modules/FxAccountsProfileClient.jsm">FxAccountsProfileClient.jsm </a>for easier Firefox Desktop integration.</p>

<h2 id="Firefox_Accounts_example_relier">Firefox Accounts example relier</h2>

<p>We created a test relier that delegates authentication to Firefox Accounts called <a href="https://123done-prod.dev.lcip.org">123done</a>, a simple TODO application. You can use this Web application to create a Firefox Accounts and use it to log in to 123done. Refer to the <a href="https://github.com/mozilla/fxa/tree/master/packages/123done">123done source code</a> for further details.</p>

<h2 id="Firefox_Accounts_deployments">Firefox Accounts deployments</h2>

<p>URLs for various production, stage, and development deployments. To use these, you can follow the directions in the <a href="https://mozilla-services.readthedocs.io/en/latest/howtos/run-fxa.html">Run your own FXA server</a>, or you might consider using <a href="https://github.com/vladikoff/fxa-dev-launcher/">vladikoff's fxa-dev-launcher</a>.</p>

<h3 id="Production">Production</h3>

<ul>
 <li>FxA OAuth 2.0 endpoint: <a href="https://oauth.accounts.firefox.com/v1">https://oauth.accounts.firefox.com/v1</a></li>
 <li>FxA profile endpoint: <a href="https://profile.accounts.firefox.com/v1">https://profile.accounts.firefox.com/v1</a></li>
 <li>FxA content (UI) server: <a href="https://accounts.firefox.com">https://accounts.firefox.com</a></li>
 <li>FxA authentication server: <a href="https://api.accounts.firefox.com/v1">https://api.accounts.firefox.com/v1</a></li>
 <li>FxA example relier: <a href="https://123done-prod.dev.lcip.org">https://123done-prod.dev.lcip.org</a></li>
</ul>

<h3 id="Stage">Stage</h3>

<ul>
 <li>FxA OAuth 2.0 endpoint: <a href="https://oauth.stage.mozaws.net/v1">https://oauth.stage.mozaws.net/v1</a></li>
 <li>FxA profile endpoint: <a href="https://profile.stage.mozaws.net/v1">https://profile.stage.mozaws.net/v1</a></li>
 <li>FxA content (UI) server: <a href="https://accounts.stage.mozaws.net">https://accounts.stage.mozaws.net</a></li>
 <li>FxA authentication server: <a href="https://api-accounts.stage.mozaws.net/v1">https://api-accounts.stage.mozaws.net/v1</a></li>
 <li>FxA example relier: <a href="https://123done-stage.dev.lcip.org">https://123done-stage.dev.lcip.org</a></li>
</ul>

<h3 id="Stable_development_production_clone" style="line-height: 24px;">Stable development (production clone)</h3>

<ul>
 <li>FxA OAuth 2.0 endpoint: <a href="https://oauth-stable.dev.lcip.org/v1">https://oauth-stable.dev.lcip.org/v1</a></li>
 <li>FxA OAuth 2.0 management console (login requires @mozilla.com email): <a href="https://oauth-stable.dev.lcip.org/console">https://oauth-stable.dev.lcip.org/console</a></li>
 <li>FxA profile endpoint: <a href="https://stable.dev.lcip.org/profile/v1">https://stable.dev.lcip.org/profile/v1</a></li>
 <li>FxA content (UI) server: <a href="https://stable.dev.lcip.org">https://stable.dev.lcip.org</a></li>
 <li>FxA authentication server: <a href="https://stable.dev.lcip.org/auth/v1">https://stable.dev.lcip.org/auth/v1</a></li>
 <li>FxA example relier: <a href="https://123done-stable.dev.lcip.org">https://123done-stable.dev.lcip.org</a></li>
</ul>

<h3 id="Latest_development_updated_continuously_from_master" style="line-height: 24px;">Latest development (updated continuously from master)</h3>

<ul>
 <li>FxA OAuth 2.0 endpoint: <a href="https://oauth-latest.dev.lcip.org/v1">https://oauth-latest.dev.lcip.org/v1</a></li>
 <li>FxA OAuth 2.0 management console (login requires @mozilla.com email): <a href="https://oauth-latest.dev.lcip.org/console">https://oauth-latest.dev.lcip.org/console</a></li>
 <li>FxA profile endpoint: <a href="https://latest.dev.lcip.org/profile/v1/profile">https://latest.dev.lcip.org/profile/v1/profile</a></li>
 <li>FxA content (UI) server: <a href="https://latest.dev.lcip.org">https://latest.dev.lcip.org</a></li>
 <li>FxA authentication server: <a href="https://latest.dev.lcip.org/auth/v1">https://latest.dev.lcip.org/auth/v1</a></li>
 <li>FxA example relier: <a href="https://123done-latest.dev.lcip.org">https://123done-latest.dev.lcip.org</a></li>
 <li>Add this <a href="https://bug1098694.bmoattachments.org/attachment.cgi?id=8759426">user.js</a> file to your profile directory to configure Firefox Sync with this environment</li>
</ul>

<h2 id="Services_that_use_Firefox_Accounts">Services that use Firefox Accounts</h2>

<p>Below is a list of current and future Mozilla services that delegate authentication to Firefox Accounts.</p>

<h3 id="Current">Current</h3>

<ul>
 <li><a href="https://www.mozilla.org/en-US/firefox/sync/">Firefox Sync</a> (since Firefox 29)</li>
 <li><a href="https://wiki.mozilla.org/CloudServices/FindMyDevice">Find My Device</a></li>
 <li><a href="/en-US/Marketplace">Firefox Marketplace</a></li>
 <li><a href="https://addons.mozilla.org">addons.mozilla.org</a></li>
</ul>

<h2 id="Contact">Contact</h2>

<ul>
 <li>Dev list: <a href="mailto:dev-fxacct@mozilla.org">dev-fxacct@mozilla.org</a></li>
 <li>IRC: #fxa</li>
</ul>

<h2 id="Additional_resources">Additional resources</h2>

<ul>
 <li><a href="/en-US/docs/Mozilla/APIs_attached_to_Firefox_Accounts">APIs attached to Firefox Accounts</a></li>
 <li><a href="https://github.com/mozilla/fxa-oauth-server/wiki/oauth-design">Original FxA OAuth design document</a></li>
 <li><a href="https://github.com/mozilla/fxa-oauth-server/blob/master/docs/api.md">FxA OAuth 2.0 API docs</a></li>
 <li><a href="https://github.com/mozilla/fxa-oauth-server/">FxA OAuth server codebase</a></li>
 <li><a href="http://tools.ietf.org/html/rfc6749">OAuth 2.0 RFC 6749</a></li>
 <li><a href="https://www.mozilla.org/en-US/about/governance/policies/security-group/bugs/">Handling Mozilla Security Bugs</a></li>
</ul>